; =============================================================================
; Windows x64 汇编编程 - Hello World 示例
; 编译命令: nasm -f win64 hello.asm -o hello.obj
; 链接命令: gcc hello.obj -o hello.exe
; =============================================================================

bits 64                    ; 指定目标处理器为64位模式
default rel                ; 默认使用RIP相对寻址，避免地址重定位错误

; =============================================================================
; 数据段定义 - 存储程序中的常量数据
; =============================================================================
section .data
    ; 定义以null结尾的字符串
    ; 格式: 标签 数据类型 初始值
    ; db = define byte (定义字节序列)
    ; 0xD = 回车符(CR), 0xA = 换行符(LF), 0 = 字符串结束符(null terminator)
    msg db 'Hello, World from ASM!', 0xD, 0xA, 0

; =============================================================================
; 代码段定义 - 包含程序执行指令
; =============================================================================
section .text
    ; 声明main函数为全局符号，链接器可识别为程序入口点
    global main
    
    ; 声明外部函数（从C运行时库链接）
    extern printf          ; 标准输出函数
    extern exit            ; 程序退出函数

; =============================================================================
; 主程序入口点
; =============================================================================
main:
    ; === 栈帧设置 ===
    ; Windows x64调用约定要求：
    ; 1. 为被调用函数预留32字节"影子空间"
    ; 2. 确保调用时栈指针(RSP)16字节对齐
    ; push rbp后RSP-8，因此分配40字节(32+8)可满足对齐要求
    sub rsp, 40
    
    ; === 调用printf函数 ===
    ; Windows x64调用约定：前4个参数通过RCX、RDX、R8、R9传递
    ; lea = Load Effective Address (加载有效地址)
    ; [msg] = 使用RIP相对寻址(由default rel确保)
    lea rcx, [msg]         ; 参数1: 字符串地址 -> RCX
    call printf            ; 调用标准输出函数
    
    ; === 程序退出 ===
    ; 使用exit()而非ret确保缓冲区刷新和完整清理
    mov ecx, 0             ; 参数1: 退出代码(0表示成功) -> ECX
    call exit              ; 调用程序退出函数
    
    ; === 栈帧清理 ===
    ; 注意: 由于调用了exit()，此处的代码不会被执行
    ; 保留这部分是为了代码的完整性和规范性
    add rsp, 40            ; 恢复栈指针(平衡之前的sub rsp, 40)
    ret                    ; 从函数返回

; =============================================================================
; 重复声明(冗余但明确) - 强调外部依赖
; =============================================================================
extern exit                ; 明确声明程序依赖的外部退出函数

; =============================================================================
; 关键知识点总结:
; 1. 必须使用 bits 64 和 default rel 开始64位汇编程序
; 2. Windows x64调用约定要求32字节影子空间和16字节栈对齐
; 3. 参数通过RCX、RDX、R8、R9寄存器传递(前4个参数)
; 4. 使用RIP相对寻址避免地址重定位错误
; 5. 调用exit()而非ret确保程序正常退出和输出刷新
; 6. 所有外部函数必须用extern声明
; =============================================================================