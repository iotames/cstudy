; =============================================================================
; Linux x86-64 汇编编程 - Hello World 示例 (兼容32位系统调用的64位代码)
; 编译命令: nasm -f elf64 hello.asm -o hello64.o
; 链接命令: ld -m elf_x86_64 -o hello64 hello64.o
; =============================================================================

; 注意: 此代码在64位模式下运行，但使用32位兼容的系统调用接口(int 0x80)
; 这是一种特殊用法，在现代Linux中仍然被支持但非推荐做法

; =============================================================================
; 数据段定义
; =============================================================================
section .data
    hello db 'Hello, World!', 0xA      ; 字符串内容，0xA是换行符(LF)
    hello_len equ $ - hello             ; 计算字符串长度

; =============================================================================
; 代码段定义
; =============================================================================
section .text
    global _start                       ; 程序入口点

; =============================================================================
; 程序入口点
; =============================================================================
_start:
    ; === 使用int 0x80系统调用(32位接口)在64位模式下 ===
    ; 注意: 这是Linux的兼容性特性，允许在64位程序中使用32位系统调用
    ; 但参数仍然使用32位寄存器
    
    ; write(1, hello, hello_len)
    mov eax, 4              ; 32位系统调用号: 4 = sys_write
    mov ebx, 1              ; 文件描述符: 1 = stdout
    mov ecx, hello          ; 字符串地址
    mov edx, hello_len      ; 字符串长度
    int 0x80                 ; 触发系统调用

    ; === 退出程序 ===
    mov eax, 1              ; 32位系统调用号: 1 = sys_exit
    mov ebx, 0              ; 退出码: 0 = 成功
    int 0x80

; =============================================================================
; 关键知识点总结:
; 
; 1. 代码兼容性: 这段代码在64位Linux中能运行是因为内核保持了向后兼容
; 2. 混合模式: 使用64位ELF格式但调用32位系统调用接口
; 3. 寄存器使用: 即使编译为64位，仍然使用32位寄存器(eax, ebx等)
; 4. 系统调用号: 使用32位的系统调用号(4=write, 1=exit)
; 
; 但这并不是标准的64位编程方式，推荐的64位写法应该使用:
; - syscall指令而非int 0x80
; - 64位系统调用号(1=write, 60=exit)  
; - 64位寄存器(rax, rdi, rsi, rdx)
; =============================================================================

; =============================================================================
; 标准64位Linux系统调用版本(推荐)
; =============================================================================
; section .data
;     hello db 'Hello, World!', 0xA
;     hello_len equ $ - hello
; 
; section .text
;     global _start
; 
; _start:
;     ; write(1, hello, hello_len)
;     mov rax, 1              ; 64位系统调用号: 1 = sys_write
;     mov rdi, 1              ; 文件描述符: 1 = stdout
;     mov rsi, hello          ; 字符串地址
;     mov rdx, hello_len       ; 字符串长度
;     syscall                  ; 64位系统调用指令
; 
;     ; exit(0)
;     mov rax, 60             ; 64位系统调用号: 60 = sys_exit
;     mov rdi, 0              ; 退出码
;     syscall
; =============================================================================